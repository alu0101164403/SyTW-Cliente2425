{"version":3,"file":"ActorQueryOperationDistinctHash.js","sourceRoot":"","sources":["ActorQueryOperationDistinctHash.ts"],"names":[],"mappings":";;;AAGA,uEAEuC;AAEvC,yCAA8C;AAS9C,2EAAgF;AAKhF;;GAEG;AACH,MAAa,+BAAgC,SAAQ,sDAAkD;IAIrG,YAAmB,IAA0C;QAC3D,KAAK,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;IAC1B,CAAC;IAEM,KAAK,CAAC,aAAa,CAAC,UAA4B,EAAE,QAAwB;QAC/E,OAAO,IAAA,mBAAY,GAAE,CAAC;IACxB,CAAC;IAEM,KAAK,CAAC,YAAY,CAAC,SAA2B,EAAE,OAAuB;QAC5E,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,SAAS,CAAC,KAAK,EAAE,OAAO,EAAE,CAAC,CAAC;QAElG,IAAI,MAAM,CAAC,IAAI,KAAK,OAAO,EAAE,CAAC;YAC5B,MAAM,WAAW,GAA+B,IAAA,oCAAY,EAC1D,MAAM,CACP,CAAC;YAEF,MAAM,UAAU,GAA4B,WAAW,CAAC,UAAU,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAC,CAAC;YAClH,OAAO;gBACL,IAAI,EAAE,OAAO;gBACb,UAAU;gBACV,QAAQ,EAAE,WAAW,CAAC,QAAQ;aAC/B,CAAC;QACJ,CAAC;QAED,MAAM,cAAc,GAAkC,IAAA,uCAAe,EACnE,MAAM,CACP,CAAC;QAEF,MAAM,SAAS,GAAG,CAAC,MAAM,cAAc,CAAC,QAAQ,EAAE,CAAC,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC;QACnF,MAAM,cAAc,GAAmB,cAAc,CAAC,cAAc;aACjE,MAAM,CAAC,MAAM,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC,CAAC;QACxD,OAAO;YACL,IAAI,EAAE,UAAU;YAChB,cAAc;YACd,QAAQ,EAAE,cAAc,CAAC,QAAQ;SAClC,CAAC;IACJ,CAAC;IAED;;;;;;OAMG;IACI,KAAK,CAAC,aAAa,CACxB,OAAuB,EACvB,SAAyB;QAEzB,MAAM,EAAE,YAAY,EAAE,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC;QAC9E,MAAM,MAAM,GAA4B,EAAE,CAAC;QAC3C,OAAO,CAAC,QAAkB,EAAE,EAAE;YAC5B,MAAM,IAAI,GAAW,YAAY,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAC;YACvD,OAAO,CAAC,CAAC,IAAI,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,CAAC;QACpD,CAAC,CAAC;IACJ,CAAC;IAED;;;;;OAKG;IACI,KAAK,CAAC,kBAAkB,CAAC,OAAuB;QACrD,MAAM,EAAE,YAAY,EAAE,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC;QAC3E,MAAM,MAAM,GAA4B,EAAE,CAAC;QAC3C,OAAO,CAAC,IAAc,EAAE,EAAE;YACxB,MAAM,IAAI,GAAW,YAAY,CAAC,IAAI,CAAC,CAAC;YACxC,OAAO,CAAC,CAAC,IAAI,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,CAAC;QACpD,CAAC,CAAC;IACJ,CAAC;CACF;AA3ED,0EA2EC","sourcesContent":["import type { MediatorHashBindings } from '@comunica/bus-hash-bindings';\nimport type { MediatorHashQuads } from '@comunica/bus-hash-quads';\nimport type { IActorQueryOperationTypedMediatedArgs } from '@comunica/bus-query-operation';\nimport {\n  ActorQueryOperationTypedMediated,\n} from '@comunica/bus-query-operation';\nimport type { IActorTest, TestResult } from '@comunica/core';\nimport { passTestVoid } from '@comunica/core';\nimport type {\n  Bindings,\n  BindingsStream,\n  IActionContext,\n  IQueryOperationResult,\n  IQueryOperationResultBindings,\n  IQueryOperationResultQuads,\n} from '@comunica/types';\nimport { getSafeBindings, getSafeQuads } from '@comunica/utils-query-operation';\nimport type * as RDF from '@rdfjs/types';\nimport type { AsyncIterator } from 'asynciterator';\nimport type { Algebra } from 'sparqlalgebrajs';\n\n/**\n * A comunica Distinct Hash Query Operation Actor.\n */\nexport class ActorQueryOperationDistinctHash extends ActorQueryOperationTypedMediated<Algebra.Distinct> {\n  public readonly mediatorHashBindings: MediatorHashBindings;\n  public readonly mediatorHashQuads: MediatorHashQuads;\n\n  public constructor(args: IActorQueryOperationDistinctHashArgs) {\n    super(args, 'distinct');\n  }\n\n  public async testOperation(_operation: Algebra.Distinct, _context: IActionContext): Promise<TestResult<IActorTest>> {\n    return passTestVoid();\n  }\n\n  public async runOperation(operation: Algebra.Distinct, context: IActionContext): Promise<IQueryOperationResult> {\n    const output = await this.mediatorQueryOperation.mediate({ operation: operation.input, context });\n\n    if (output.type === 'quads') {\n      const outputQuads: IQueryOperationResultQuads = getSafeQuads(\n        output,\n      );\n\n      const quadStream: AsyncIterator<RDF.Quad> = outputQuads.quadStream.filter(await this.newHashFilterQuads(context));\n      return {\n        type: 'quads',\n        quadStream,\n        metadata: outputQuads.metadata,\n      };\n    }\n\n    const outputBindings: IQueryOperationResultBindings = getSafeBindings(\n      output,\n    );\n\n    const variables = (await outputBindings.metadata()).variables.map(v => v.variable);\n    const bindingsStream: BindingsStream = outputBindings.bindingsStream\n      .filter(await this.newHashFilter(context, variables));\n    return {\n      type: 'bindings',\n      bindingsStream,\n      metadata: outputBindings.metadata,\n    };\n  }\n\n  /**\n   * Create a new distinct filter function.\n   * This will maintain an internal hash datastructure so that every bindings object only returns true once.\n   * @param context The action context.\n   * @param variables The variables to take into account while hashing.\n   * @return {(bindings: Bindings) => boolean} A distinct filter for bindings.\n   */\n  public async newHashFilter(\n    context: IActionContext,\n    variables: RDF.Variable[],\n  ): Promise<(bindings: Bindings) => boolean> {\n    const { hashFunction } = await this.mediatorHashBindings.mediate({ context });\n    const hashes: Record<number, boolean> = {};\n    return (bindings: Bindings) => {\n      const hash: number = hashFunction(bindings, variables);\n      return !(hash in hashes) && (hashes[hash] = true);\n    };\n  }\n\n  /**\n   * Create a new distinct filter function to hash quads.\n   * This will maintain an internal hash datastructure so that every quad object only returns true once.\n   * @param context The action context.\n   * @return {(quad: RDF.Quad) => boolean} A distinct filter for quads.\n   */\n  public async newHashFilterQuads(context: IActionContext): Promise<(quad: RDF.Quad) => boolean> {\n    const { hashFunction } = await this.mediatorHashQuads.mediate({ context });\n    const hashes: Record<number, boolean> = {};\n    return (quad: RDF.Quad) => {\n      const hash: number = hashFunction(quad);\n      return !(hash in hashes) && (hashes[hash] = true);\n    };\n  }\n}\n\nexport interface IActorQueryOperationDistinctHashArgs extends IActorQueryOperationTypedMediatedArgs {\n  mediatorHashBindings: MediatorHashBindings;\n  mediatorHashQuads: MediatorHashQuads;\n}\n"]}